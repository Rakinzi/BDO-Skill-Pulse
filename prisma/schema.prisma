generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  department    String
  isAdmin       Boolean        @default(false)
  createdAt     DateTime       @default(now()) @map("createdAt")
  quizResponses QuizResponse[]

  @@map("User")
}

model QuizSession {
  id        String         @id @default(uuid())
  name      String
  date      DateTime
  time      String
  questions String
  createdBy String
  isActive  Boolean        @default(false)
  createdAt DateTime       @default(now())
  responses QuizResponse[]

  @@map("QuizSession")
}

model QuizResponse {
  id          String      @id @default(uuid())
  sessionId   String
  userId      String
  answers     String
  score       Int
  timeSpent   Int
  completedAt DateTime    @default(now())
  session     QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("QuizResponse")
}

// Password Reset System
model PasswordReset {
  id                String   @id @default(uuid())
  userEmail         String   @unique
  resetCount        Int      @default(0)
  monthlyCount      Int      @default(0)
  lastReset         DateTime?
  monthlyResetDate  DateTime?
  createdAt         DateTime @default(now())

  @@map("PasswordReset")
}

// Admin Reset Requests
model AdminResetRequest {
  id          String   @id @default(uuid())
  userEmail   String
  reason      String
  status      String   @default("pending") // pending, approved, rejected
  adminNotes  String?
  requestedAt DateTime @default(now())
  processedAt DateTime?
  processedBy String?

  @@map("AdminResetRequest")
}

// Quiz Progress Auto-save
model QuizProgress {
  id           String   @id @default(uuid())
  userEmail    String
  sessionId    String
  answers      String   @default("{}")
  timeRemaining Int     @default(300) // 5 minutes in seconds
  lastSaved    DateTime @default(now())

  @@unique([userEmail, sessionId])
  @@map("QuizProgress")
}

// User Sessions for JWT management
model UserSession {
  id            String   @id @default(uuid())
  userEmail     String
  sessionToken  String
  refreshToken  String
  expiresAt     DateTime
  lastActivity  DateTime @default(now())
  createdAt     DateTime @default(now())

  @@map("UserSession")
}

// Quiz Feedback System
model QuizFeedback {
  id          String   @id @default(uuid())
  userEmail   String
  sessionId   String
  rating      Int      // 1-5 stars
  comments    String?
  submittedAt DateTime @default(now())

  @@map("QuizFeedback")
}

// User Notifications
model UserNotification {
  id          String   @id @default(uuid())
  userEmail   String
  type        String   // 'warning', 'quiz_posted', 'reminder', etc.
  title       String
  message     String
  adminEmail  String?
  quizName    String?
  departmentName String?
  read        Boolean  @default(false)
  timestamp   DateTime @default(now())

  @@map("UserNotification")
}

// User Warnings Tracking
model UserWarning {
  id          String   @id @default(uuid())
  userEmail   String
  adminEmail  String
  quizName    String?
  reason      String
  timestamp   DateTime @default(now())

  @@map("UserWarning")
}

// Retake Tracking
model UserRetake {
  id            String   @id @default(uuid())
  userEmail     String
  sessionId     String
  attempts      Int      @default(0)
  cooldownUntil DateTime?
  canRetake     Boolean  @default(false)
  lastAttempt   DateTime?

  @@unique([userEmail, sessionId])
  @@map("UserRetake")
}

// Question Bank for reusable questions
model QuestionBank {
  id            String   @id @default(uuid())
  questionText  String
  questionType  String   @default("multiple-choice") // multiple-choice, true-false
  options       String?  // For multiple choice options
  correctAnswer String   // Can be string, boolean, or array
  category      String?
  difficulty    String   @default("medium") // easy, medium, hard
  tags          String   @default("[]")
  createdBy     String
  createdAt     DateTime @default(now())

  @@map("QuestionBank")
}

// Quiz Templates
model QuizTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  department  String?
  questionIds String   @default("[]") // Array of question bank IDs
  timeLimit   Int      @default(300) // Time limit in seconds
  createdBy   String
  createdAt   DateTime @default(now())

  @@map("QuizTemplate")
}

// Audit Logs
model AuditLog {
  id         String   @id @default(uuid())
  adminEmail String
  action     String   // create_quiz, warn_user, elevate_user, etc.
  details    String   @default("{}")
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@map("AuditLog")
}

// Question Analytics
model QuestionAnalytics {
  id            String   @id @default(uuid())
  sessionId      String
  questionIndex  Int
  questionText   String
  correctAnswers Int      @default(0)
  totalAttempts  Int      @default(0)
  averageTime    Float?
  createdAt      DateTime @default(now())

  @@unique([sessionId, questionIndex])
  @@map("QuestionAnalytics")
}

// Department Performance Analytics
model DepartmentAnalytics {
  id            String   @id @default(uuid())
  department    String
  date          DateTime
  totalQuizzes  Int      @default(0)
  averageScore  Float?
  passRate      Float?
  topPerformers String   @default("[]")
  createdAt     DateTime @default(now())

  @@unique([department, date])
  @@map("DepartmentAnalytics")
}
